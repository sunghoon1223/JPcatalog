import{j as e}from"./ui-vendor-D7YrltUJ.js";import{r as a,c as Q}from"./react-vendor-XbLGo5ol.js";import{o as E,p as W,q as Y,u as $,r as J,s as K,D as P,t as B,L as N,C as X,b as Z,d as ee,g as se,a as ae,I as M,e as V,v as te,w as A}from"./index-iJ4ZFglL.js";import{L as q}from"./label-HICMNMR8.js";import{S as ne}from"./shield-BOUc24LI.js";const re=W("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),S=a.forwardRef(({className:c,variant:t,...n},b)=>e.jsx("div",{ref:b,role:"alert",className:E(re({variant:t}),c),...n}));S.displayName="Alert";const oe=a.forwardRef(({className:c,...t},n)=>e.jsx("h5",{ref:n,className:E("mb-1 font-medium leading-none tracking-tight",c),...t}));oe.displayName="AlertTitle";const C=a.forwardRef(({className:c,...t},n)=>e.jsx("div",{ref:n,className:E("text-sm [&_p]:leading-relaxed",c),...t}));C.displayName="AlertDescription";function ge(){const{signIn:c,user:t,loading:n,loginDevBypass:b}=Y(),d=Q(),{t:s}=$(),[j,D]=a.useState({email:"",password:""}),[R,L]=a.useState(null),[I,p]=a.useState(null),[w,l]=a.useState(!1),[U,H]=a.useState(!1),[O,x]=a.useState(!1),k=a.useRef(!1),u=a.useRef(!1),h=a.useRef(null),y=J(),z=typeof window<"u"&&/^(localhost|127\.0\.0\.1|0\.0\.0\.0)$/i.test(window.location.hostname),m=K(),v=m&&O;typeof window<"u"&&console.log("dev bypass flags",{supabaseEnv:y,isLocalHost:z,isDevBypass:m}),a.useEffect(()=>{!n&&t&&t.role==="admin"&&d("/admin/dashboard")},[t,n,d]),a.useEffect(()=>{if(console.log("auto-login effect check",{isDevBypass:m,loading:n,hasUser:!!t,autoLoginAttempted:U,supabaseEnv:y}),!m||n||t||k.current)return;let r=!1;console.log("auto-login scheduling"),k.current=!0,H(!0),p(null),l(!0),x(!0),u.current=!0;const o=window.setTimeout(async()=>{var g,_;if(h.current=null,r){console.log("auto-login cancelled before attempt");return}try{console.log("auto login attempt",{email:P});const{error:i,data:f}=await b();if(console.log("auto login result",{error:(i==null?void 0:i.message)??null,role:((g=f==null?void 0:f.user)==null?void 0:g.role)??null}),r){console.log("auto-login cancelled after sign-in result");return}if(i){p(i.message??s("admin.login.errors.devAutoLoginFailed")),l(!1),x(!1),u.current=!1,console.warn("auto login error",i);return}const F=(_=f==null?void 0:f.user)==null?void 0:_.role;if(F!=="admin"){p(s("admin.login.errors.noAdminRole")),l(!1),x(!1),u.current=!1,console.warn("auto login role mismatch",{role:F});return}x(!1),u.current=!1,l(!1),console.log("auto login success, navigating to dashboard"),d("/admin/dashboard",{replace:!0})}catch(i){if(r)return;p(s("admin.login.errors.autoLoginUnknown")),l(!1),x(!1),u.current=!1,console.error("auto login unexpected error",i)}},B);return h.current=o,()=>{r=!0,h.current!==null&&(window.clearTimeout(h.current),h.current=null,u.current=!1,console.log("auto-login cleanup invoked"))}},[m,n,t,b,d,y]);const G=async r=>{r.preventDefault(),l(!0),L(null),p(null);const{error:o,data:g}=await c(j.email,j.password);if(o){L(o.message),A.error(o.message),l(!1);return}if((g==null?void 0:g.user.role)!=="admin"){L(s("admin.login.errors.missingRole")),A.error(s("admin.login.errors.missingRole")),l(!1);return}A.success(s("admin.login.toast.success")),d("/admin/dashboard")},T=R??I;return n?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800",children:e.jsx(N,{className:"h-8 w-8 animate-spin text-white"})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4",children:e.jsxs(X,{className:"w-full max-w-md shadow-2xl",children:[e.jsxs(Z,{className:"space-y-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-full",children:e.jsx(ne,{className:"h-8 w-8 text-blue-600"})})}),e.jsx(ee,{className:"text-2xl font-bold text-center",children:s("admin.login.title")}),e.jsx(se,{className:"text-center",children:s("admin.login.subtitle")})]}),e.jsxs(ae,{children:[m&&e.jsx(S,{className:"mb-4 border-amber-300 bg-amber-50 text-amber-900",children:e.jsxs(C,{className:"space-y-1",children:[e.jsx("span",{className:"font-semibold",children:s("admin.login.devBannerTitle")}),e.jsxs("p",{className:"text-sm",children:[s("admin.login.devAutoLoginNotice",{seconds:B/1e3}),s("admin.login.devWarning")]}),v&&!I&&!R&&e.jsxs("span",{className:"mt-1 inline-flex items-center text-xs text-amber-700",children:[e.jsx(N,{className:"mr-2 h-3 w-3 animate-spin"})," ",s("admin.login.devAutoLoginInProgress")]})]})}),e.jsxs("form",{onSubmit:G,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"email",children:s("admin.login.form.email")}),e.jsx(M,{id:"email",type:"email",value:j.email,onChange:r=>D(o=>({...o,email:r.target.value})),placeholder:P,required:!0,disabled:w||v,autoComplete:"email"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"password",children:s("admin.login.form.password")}),e.jsx(M,{id:"password",type:"password",value:j.password,onChange:r=>D(o=>({...o,password:r.target.value})),placeholder:s("admin.login.form.passwordPlaceholder"),required:!0,minLength:8,disabled:w||v,autoComplete:"current-password"})]}),T&&e.jsx(S,{variant:"destructive",children:e.jsx(C,{children:T})}),e.jsx(V,{type:"submit",className:"w-full",disabled:w||v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),s("admin.login.devAutoLoginQueued")]}):w?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),s("admin.login.submitting")]}):s("admin.login.button")})]})]}),e.jsxs(te,{className:"flex flex-col space-y-2",children:[e.jsx("p",{className:"text-center text-sm text-muted-foreground",children:s("admin.login.forgot")}),e.jsx(V,{variant:"ghost",size:"sm",onClick:()=>d("/"),className:"text-sm",children:s("admin.login.backToSite")})]})]})})}export{ge as default};
