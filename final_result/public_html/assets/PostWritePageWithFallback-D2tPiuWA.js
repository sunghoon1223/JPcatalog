import{j as e}from"./ui-vendor-hOSTw39_.js";import{u as W,r as c,e as X}from"./react-vendor-CE1B3BJh.js";import{$ as H,f as u,al as B,E as G,C as k,d as z,e as D,a as I,L as f,I as N,v as J,w as Y,x as Z,y as ee,z as M,ak as te,af as L,T as ae,a3 as se,B as re,ar as P,_ as b,as as ne}from"./index-Bs0BOd1P.js";import{S as T}from"./save-Byx2KDR7.js";import{U as ie}from"./upload-hzYvcx0b.js";function le({board:r,post:t,mode:x="create",onSubmit:o,onCancel:v}){var A;const q=W(),{user:_}=H(),[j,g]=c.useState(!1),[S,h]=c.useState(!1),[a,y]=c.useState({title:(t==null?void 0:t.title)||"",content:(t==null?void 0:t.content)||"",post_type:(t==null?void 0:t.post_type)||"normal",is_pinned:(t==null?void 0:t.is_pinned)||!1,author_name:(t==null?void 0:t.author_name)||"",author_email:(t==null?void 0:t.author_email)||"",author_password:""}),[l,C]=c.useState([]),E=((A=_==null?void 0:_.user_metadata)==null?void 0:A.role)==="admin",p=!_,m=x==="edit";c.useEffect(()=>{t&&m&&y({title:t.title,content:t.content,post_type:t.post_type,is_pinned:t.is_pinned,author_name:t.author_name||"",author_email:t.author_email||"",author_password:""})},[t,m]);const d=()=>{v?v():q(`/board/${r.slug}`)},n=(s,i)=>{y(w=>({...w,[s]:i}))},K=s=>{const i=Array.from(s.target.files||[]),w=r.settings.max_attachment_size||10*1024*1024,O=i.filter($=>$.size>w?(alert(`파일 크기가 너무 큽니다. 최대 ${Math.round(w/1024/1024)}MB까지 업로드 가능합니다.`),!1):!0);C($=>[...$,...O])},V=s=>{C(i=>i.filter((w,O)=>O!==s))},F=async s=>{if(s.preventDefault(),!a.title.trim()||!a.content.trim()){alert("제목과 내용을 입력해주세요.");return}if(p&&(!a.author_name.trim()||!a.author_email.trim())){alert("익명 게시글의 경우 작성자 이름과 이메일을 입력해주세요.");return}g(!0);try{if(m){const i={title:a.title,content:a.content,post_type:a.post_type,is_pinned:a.is_pinned};await(o==null?void 0:o(i))}else{const i={board_id:r.id,title:a.title,content:a.content,post_type:a.post_type,is_pinned:a.is_pinned,author_name:p?a.author_name:void 0,author_email:p?a.author_email:void 0,author_password:p?a.author_password:void 0,attachments:l.length>0?l:void 0};await(o==null?void 0:o(i))}}finally{g(!1)}},Q=s=>{switch(s){case"notice":return"공지";case"pinned":return"고정";default:return"일반"}},R=()=>e.jsxs(k,{children:[e.jsx(z,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[a.is_pinned&&e.jsx(L,{className:"h-4 w-4 text-red-500"}),a.post_type!=="normal"&&e.jsx(re,{variant:a.post_type==="notice"?"destructive":"secondary",children:Q(a.post_type)}),e.jsx(D,{children:a.title||"제목을 입력하세요"})]})}),e.jsxs(I,{children:[e.jsx("div",{className:"prose prose-sm max-w-none whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:a.content||"내용을 입력하세요"}}),l.length>0&&e.jsxs("div",{className:"mt-6 pt-4 border-t",children:[e.jsx("h4",{className:"font-medium mb-2",children:"첨부파일"}),e.jsx("ul",{className:"space-y-1",children:l.map((s,i)=>e.jsxs("li",{className:"text-sm text-gray-600",children:[s.name," (",Math.round(s.size/1024),"KB)"]},i))})]})]})]});return S?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(u,{variant:"ghost",size:"sm",onClick:()=>h(!1),children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"편집으로 돌아가기"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(u,{onClick:F,disabled:j,children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),j?"저장 중...":m?"수정 완료":"게시글 작성"]})})]}),R()]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(u,{variant:"ghost",size:"sm",onClick:d,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),r.name]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:m?"게시글 수정":"게시글 작성"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(u,{variant:"outline",onClick:()=>h(!0),disabled:!a.title.trim()||!a.content.trim(),children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"미리보기"]}),e.jsxs(u,{onClick:F,disabled:j,children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),j?"저장 중...":m?"수정 완료":"게시글 작성"]})]})]}),e.jsxs("form",{onSubmit:F,className:"space-y-6",children:[e.jsxs(k,{children:[e.jsx(z,{children:e.jsx(D,{children:"게시글 정보"})}),e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"title",children:"제목 *"}),e.jsx(N,{id:"title",value:a.title,onChange:s=>n("title",s.target.value),placeholder:"게시글 제목을 입력하세요",required:!0})]}),E&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"post_type",children:"게시글 유형"}),e.jsxs(J,{value:a.post_type,onValueChange:s=>n("post_type",s),children:[e.jsx(Y,{children:e.jsx(Z,{})}),e.jsxs(ee,{children:[e.jsx(M,{value:"normal",children:"일반 게시글"}),e.jsx(M,{value:"notice",children:"공지사항"}),e.jsx(M,{value:"pinned",children:"고정 게시글"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 pt-8",children:[e.jsx(te,{id:"is_pinned",checked:a.is_pinned,onCheckedChange:s=>n("is_pinned",s)}),e.jsxs(f,{htmlFor:"is_pinned",className:"flex items-center gap-1",children:[e.jsx(L,{className:"h-4 w-4"}),"상단 고정"]})]})]}),p&&r.settings.allow_anonymous&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"author_name",children:"작성자 이름 *"}),e.jsx(N,{id:"author_name",value:a.author_name,onChange:s=>n("author_name",s.target.value),placeholder:"이름을 입력하세요",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"author_email",children:"이메일 *"}),e.jsx(N,{id:"author_email",type:"email",value:a.author_email,onChange:s=>n("author_email",s.target.value),placeholder:"이메일을 입력하세요",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"author_password",children:"비밀번호 *"}),e.jsx(N,{id:"author_password",type:"password",value:a.author_password,onChange:s=>n("author_password",s.target.value),placeholder:"게시글 수정/삭제용 비밀번호",required:!0})]})]})]})]}),e.jsxs(k,{children:[e.jsx(z,{children:e.jsx(D,{children:"게시글 내용"})}),e.jsx(I,{children:e.jsx(ae,{value:a.content,onChange:s=>n("content",s.target.value),placeholder:"게시글 내용을 입력하세요",rows:15,className:"resize-none",required:!0})})]}),r.settings.allow_attachments&&e.jsxs(k,{children:[e.jsx(z,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5"}),"첨부파일"]})}),e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(N,{type:"file",multiple:!0,onChange:K,className:"file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["최대 ",Math.round((r.settings.max_attachment_size||10*1024*1024)/1024/1024),"MB까지 업로드 가능합니다."]})]}),l.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium",children:"선택된 파일"}),l.map((s,i)=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[e.jsxs("span",{className:"text-sm",children:[s.name," (",Math.round(s.size/1024),"KB)"]}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",onClick:()=>V(i),children:e.jsx(se,{className:"h-4 w-4"})})]},i))]})]})]})]})]})}const U={notice:{id:"1",name:"공지사항",slug:"notice",type:"notice",description:"중요한 공지사항을 확인하세요",settings:{allow_anonymous:!1,require_approval:!1,allow_comments:!0,allow_attachments:!0,max_attachment_size:10485760},sort_order:1,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},qna:{id:"2",name:"Q&A",slug:"qna",type:"qna",description:"궁금한 점을 문의하세요",settings:{allow_anonymous:!0,require_approval:!1,allow_comments:!0,allow_attachments:!0,max_attachment_size:10485760},sort_order:2,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},review:{id:"3",name:"제품 리뷰",slug:"review",type:"review",description:"제품 사용 후기를 공유하세요",settings:{allow_anonymous:!1,require_approval:!0,allow_comments:!0,allow_attachments:!0,max_attachment_size:10485760},sort_order:3,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},general:{id:"4",name:"자유게시판",slug:"general",type:"general",description:"자유롭게 소통하는 공간",settings:{allow_anonymous:!0,require_approval:!1,allow_comments:!0,allow_attachments:!0,max_attachment_size:10485760},sort_order:4,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}};function ue(){const{boardSlug:r,postId:t}=X(),x=W();H();const[o,v]=c.useState(null),[q,_]=c.useState(null),[j,g]=c.useState(!0),[S,h]=c.useState(null),[a,y]=c.useState(!1),l=!!t;c.useEffect(()=>{C()},[r,t]);const C=async()=>{if(!r){h("게시판을 찾을 수 없습니다."),g(!1);return}try{g(!0),h(null),y(!1);const d=await P.getBoard(r);if(!d)throw new Error("게시판을 찾을 수 없습니다.");if(v(d),l&&t){const n=await P.getPost(t);if(!n){h("게시글을 찾을 수 없습니다.");return}_(n)}}catch(d){if(console.error("Board/Post data loading error:",d),r&&U[r]){if(console.log("Using fallback data for board:",r),v(U[r]),y(!0),h(null),l){b({title:"오프라인 모드",description:"오프라인 모드에서는 게시글을 수정할 수 없습니다.",variant:"destructive"}),x(`/board/${r}`);return}}else h(d.message||"데이터를 불러오는데 실패했습니다.")}finally{g(!1)}},E=async d=>{if(a){b({title:"오프라인 모드",description:"현재 오프라인 모드입니다. 인터넷 연결을 확인해주세요.",variant:"destructive"});return}try{if(l&&t)await P.updatePost(t,d),b({title:"게시글 수정 완료",description:"게시글이 성공적으로 수정되었습니다."}),x(`/board/${r}/post/${t}`);else{const n=await P.createPost(d);b({title:"게시글 작성 완료",description:"게시글이 성공적으로 작성되었습니다."}),x(`/board/${r}/post/${n.id}`)}}catch(n){console.error("Post submit error:",n),b({title:"오류 발생",description:n.message||"게시글 저장에 실패했습니다.",variant:"destructive"})}},p=()=>{x(`/board/${r}`)},m=()=>{x(`/board/${r}`)};return j?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(ne,{className:"mx-auto"})}):S||!o?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"오류 발생"}),e.jsx("p",{className:"text-gray-600 mb-6",children:S||"게시판을 찾을 수 없습니다."}),e.jsxs(u,{onClick:m,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"게시판으로 돌아가기"]})]})}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs(u,{variant:"ghost",size:"sm",onClick:m,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),o.name," 게시판"]}),a&&e.jsx("div",{className:"text-sm text-orange-600 bg-orange-50 px-3 py-1 rounded-md",children:"오프라인 모드 - 게시글 작성 기능 제한"})]}),e.jsx(le,{board:o,post:q,isEditMode:l,onSubmit:E,onCancel:p})]})}export{ue as default};
